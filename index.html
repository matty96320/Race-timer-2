<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enduro Race Timer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #374151; }
    .container { max-width: 1200px; }
    .card { background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 2rem; }
    .button { transition: transform 0.1s ease-in-out, box-shadow 0.1s ease-in-out; }
    .button:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
    .header-bg { background: linear-gradient(to right, #4c51bf, #6b46c1); }
    table { border-collapse: separate; border-spacing: 0; }
    th, td { padding: 0.75rem; text-align: left; }
    thead th { background-color: #e5e7eb; color: #4b5563; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
    tbody tr { background-color: #ffffff; border-bottom: 1px solid #e5e7eb; }
    tbody tr:nth-child(even) { background-color: #f9fafb; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">

<!-- Firebase SDKs -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, onSnapshot, setDoc, updateDoc, collection, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // --- Firebase Config ---
  const firebaseConfig = {
    apiKey: "AIzaSyCrKQpx3rZN2Y0Asy8HL08kv89eVQhoDck",
    authDomain: "race-timer-6b61e.firebaseapp.com",
    projectId: "race-timer-6b61e",
    storageBucket: "race-timer-6b61e.firebasestorage.app",
    messagingSenderId: "933028970429",
    appId: "1:933028970429:web:937f82036c8c3258de5cd4",
    measurementId: "G-W8XG2RDYP0"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let userId = null;
  let currentRaceId = null;
  let raceData = { riders: [], stages: 6 };
  let raceUnsubscribe = null;
  let timersUnsubscribe = null;
  let activeTimers = {};
  let historyStack = [];

  // --- Auth ---
  onAuthStateChanged(auth, async (user) => {
    if (!user) { await signInAnonymously(auth); }
    userId = auth.currentUser ? auth.currentUser.uid : "anonymous";
    document.getElementById("userIdDisplay").textContent = `User ID: ${userId}`;
  });

  // --- Utility ---
  const pushHistory = () => {
    historyStack.push(JSON.stringify(raceData));
    if (historyStack.length > 20) historyStack.shift();
  };
  const undoLastAction = async () => {
    if (historyStack.length === 0 || !currentRaceId) return;
    const prevState = JSON.parse(historyStack.pop());
    raceData = prevState;
    const raceDocRef = doc(db, "races", currentRaceId);
    await setDoc(raceDocRef, raceData);
    showMessage("Last action undone.");
  };
  const showMessage = (msg, error=false) => {
    const el = document.getElementById("messageBox");
    el.textContent = msg;
    el.className = `p-3 rounded-md text-center font-semibold mb-4 ${error ? "bg-red-500" : "bg-green-500"} text-white`;
    setTimeout(()=>{ el.textContent=""; el.className=""; },3000);
  };
  const formatTime = (s) => {
    if (s==null) return "N/A";
    const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=Math.floor(s%60);
    return [h,m,sec].map(v=>v.toString().padStart(2,"0")).join(":");
  };

  // --- Race Logic ---
  const setupRaceListener = (raceId) => {
    if (raceUnsubscribe) raceUnsubscribe();
    currentRaceId = raceId;
    const raceDocRef = doc(db, "races", raceId);
    raceUnsubscribe = onSnapshot(raceDocRef, (docSnap)=>{
      if (docSnap.exists()) {
        raceData = docSnap.data();
        renderRaceData();
      } else {
        setDoc(raceDocRef, raceData);
      }
    });
    setupTimersListener(raceId);
  };

  const setupTimersListener = (raceId) => {
    if (timersUnsubscribe) timersUnsubscribe();
    const timersCollectionRef = collection(db, "races", raceId, "timers");
    timersUnsubscribe = onSnapshot(timersCollectionRef, (qSnap)=>{
      activeTimers={};
      qSnap.forEach(doc=> activeTimers[doc.id] = {...doc.data(), id:doc.id});
      renderActiveTimers();
    });
  };

  const addRider = async (e) => {
    e.preventDefault();
    if (!currentRaceId) return showMessage("Load or create a race first", true);
    pushHistory();
    const riderNumber=parseInt(document.getElementById("riderNumber").value);
    const riderName=document.getElementById("riderName").value.trim();
    raceData.riders.push({ number:riderNumber, name:riderName, times:Array(raceData.stages).fill(null), totalTime:null });
    await updateDoc(doc(db,"races",currentRaceId),{riders:raceData.riders});
    e.target.reset();
    showMessage("Rider added");
  };

  const updateTime = async (riderNumber, stageIndex, seconds) => {
    pushHistory();
    const idx=raceData.riders.findIndex(r=>r.number===riderNumber);
    if (idx===-1) return;
    raceData.riders[idx].times[stageIndex]=seconds;
    raceData.riders[idx].totalTime = raceData.riders[idx].times.every(t=>t!=null)
      ? raceData.riders[idx].times.reduce((a,b)=>a+b,0) : null;
    await updateDoc(doc(db,"races",currentRaceId),{riders:raceData.riders});
  };

  const startTimer = async () => {
    if (!currentRaceId) return;
    const riderNumber=document.getElementById("timingRiderInput").value;
    const stageIndex=document.getElementById("timingStageSelect").value;
    if (!riderNumber || stageIndex==="") return;
    await setDoc(doc(db,"races",currentRaceId,"timers",`${riderNumber}-${stageIndex}`),{
      riderNumber:parseInt(riderNumber), stageIndex:parseInt(stageIndex), startTime:Date.now()
    });
  };

  const stopSpecificTimer = async (riderNumber, stageIndex) => {
    const timerDocRef=doc(db,"races",currentRaceId,"timers",`${riderNumber}-${stageIndex}`);
    const snap=await getDoc(timerDocRef);
    if (snap.exists()) {
      const data=snap.data();
      const elapsed=Math.floor((Date.now()-data.startTime)/1000);
      await updateTime(riderNumber, data.stageIndex, elapsed);
      await deleteDoc(timerDocRef);
      showMessage(`Timer stopped for Rider #${riderNumber}`);
    }
  };

  // --- Rendering ---
  const renderActiveTimers = () => {
    const ul=document.getElementById("activeTimersList");
    ul.innerHTML="";
    Object.values(activeTimers).forEach(timer=>{
      const li=document.createElement("li");
      li.className="flex justify-between items-center p-2 bg-gray-100 rounded-md";
      li.textContent=`Rider #${timer.riderNumber} Stage ${timer.stageIndex+1}`;
      const btn=document.createElement("button");
      btn.textContent="Stop";
      btn.className="ml-2 px-3 py-1 bg-red-600 text-white rounded";
      btn.onclick=()=>stopSpecificTimer(timer.riderNumber,timer.stageIndex);
      li.appendChild(btn);
      ul.appendChild(li);
    });
    if (!ul.hasChildNodes()) ul.innerHTML="<li class='text-sm text-gray-500'>No active timers</li>";
  };

  const renderRaceData = () => {
    const tbody=document.getElementById("ridersTableBody");
    const results=document.getElementById("resultsTableBody");
    tbody.innerHTML=""; results.innerHTML="";
    raceData.riders.forEach(rider=>{
      const row=document.createElement("tr");
      row.innerHTML=`<td>${rider.number}</td><td>${rider.name}</td>`;
      rider.times.forEach((t,i)=>{
        const td=document.createElement("td");
        td.textContent=formatTime(t);
        td.onclick=()=>{
          const val=prompt("Enter new time (HH:MM:SS)", formatTime(t));
          if (val) {
            const parts=val.split(":").map(Number);
            const sec=parts.reduce((acc,v)=>acc*60+v);
            updateTime(rider.number,i,sec);
          }
        };
        row.appendChild(td);
      });
      const tdTotal=document.createElement("td");
      tdTotal.textContent=formatTime(rider.totalTime);
      row.appendChild(tdTotal);
      tbody.appendChild(row);
    });
    [...raceData.riders].filter(r=>r.totalTime!=null)
      .sort((a,b)=>a.totalTime-b.totalTime)
      .forEach((r,i)=>{
        results.innerHTML+=`<tr><td>${i+1}</td><td>${r.number}</td><td>${r.name}</td><td>${formatTime(r.totalTime)}</td></tr>`;
      });
  };

  // --- Export ---
  const exportResults = () => {
    const ws_data=[["Rider #","Name",...Array.from({length:raceData.stages},(_,i)=>`Stage ${i+1}`),"Total"]];
    raceData.riders.forEach(r=>{
      ws_data.push([r.number,r.name,...r.times.map(formatTime),formatTime(r.totalTime)]);
    });
    const ws=XLSX.utils.aoa_to_sheet(ws_data);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"Results");
    XLSX.writeFile(wb,`race_${currentRaceId}_results.xlsx`);
  };

  // --- DOM ---
  window.addEventListener("DOMContentLoaded",()=>{
    document.getElementById("loadRaceBtn").onclick=()=>{
      const id=document.getElementById("raceIdInput").value.trim()||`race_${Date.now()}`;
      document.getElementById("currentRaceIdDisplay").textContent=`Race ID: ${id}`;
      setupRaceListener(id);
    };
    document.getElementById("riderForm").onsubmit=addRider;
    document.getElementById("startTimerBtn").onclick=startTimer;
    document.getElementById("undoBtn").onclick=undoLastAction;
    document.getElementById("exportBtn").onclick=exportResults;
  });
</script>

<div class="container mx-auto">
  <header class="header-bg text-white w-full p-6 rounded-xl text-center shadow-lg mb-8">
    <h1 class="text-3xl font-extrabold">Enduro Race Timer</h1>
  </header>

  <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
    <div class="flex justify-between text-sm mb-2">
      <span id="userIdDisplay">User ID: Loading...</span>
    </div>
    <input id="raceIdInput" class="border p-2 rounded w-full mb-2" placeholder="Enter or create Race ID"/>
    <button id="loadRaceBtn" class="button px-4 py-2 bg-indigo-600 text-white rounded">Load/Create Race</button>
    <p id="currentRaceIdDisplay" class="mt-2 font-bold"></p>
    <div id="messageBox" class="mt-2"></div>
  </div>

  <div class="card mb-8">
    <h2 class="text-xl font-bold mb-2">Start Timer</h2>
    <select id="timingRiderInput" class="border p-2 rounded w-full mb-2">
      <option value="">Select Rider</option>
    </select>
    <select id="timingStageSelect" class="border p-2 rounded w-full mb-2">
      <option value="">Select Stage</option>
    </select>
    <button id="startTimerBtn" class="button px-4 py-2 bg-green-600 text-white rounded">Start Timer</button>
  </div>

  <div class="card mb-8">
    <h2 class="text-xl font-bold mb-2">Active Timers</h2>
    <ul id="activeTimersList"><li>No active timers</li></ul>
  </div>

  <div class="card mb-8">
    <h2 class="text-xl font-bold mb-2">Add Rider</h2>
    <form id="riderForm" class="flex gap-2">
      <input id="riderNumber" type="number" placeholder="Number" class="border p-2 rounded flex-1" required/>
      <input id="riderName" placeholder="Name" class="border p-2 rounded flex-1" required/>
      <button class="button px-4 py-2 bg-emerald-600 text-white rounded">Add</button>
    </form>
  </div>

  <div class="card mb-8">
    <h2 class="text-xl font-bold mb-2">Rider & Stage Times</h2>
    <table class="w-full">
      <thead><tr><th>#</th><th>Name</th></tr></thead>
      <tbody id="ridersTableBody"></tbody>
    </table>
  </div>

  <div class="card mb-8">
    <h2 class="text-xl font-bold mb-2">Current Standings</h2>
    <table class="w-full">
      <thead><tr><th>Rank</th><th>#</th><th>Name</th><th>Total</th></tr></thead>
      <tbody id="resultsTableBody"></tbody>
    </table>
    <div class="mt-4 flex gap-2">
      <button id="undoBtn" class="px-4 py-2 bg-yellow-500 text-white rounded">Undo Last Action</button>
      <button id="exportBtn" class="px-4 py-2 bg-blue-600 text-white rounded">Export Results</button>
    </div>
  </div>
</div>

</body>
</html>